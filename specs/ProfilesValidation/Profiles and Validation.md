FHIR is a platform standard. It follows the 80-20 rule; the basic fields of each resource represent what would cover 80% of what is needed and the use cases that fall in the other 20% would be expected to use extensions to add data to resources. Consequently, FHIR is very extensible. This also means that most practical use cases would need to constrain the data in some ways. Examples of such constraints may be to require the the Patient resource uses a certain specific identifier or one of just a few sets of identifiers. Customers will expect that our FHIR server has the ability to validate resources before they are created or updated (they may also want to validate if a certain resource can be deleted). 

The FHIR server needs the following capabilities:

1. Validate that a resource conforms to the base resource profile.
1. Validate that a resource conforms to a specific (custom) profile. 
1. Validate a resource before without upserting it.
1. Validate referential integrity, e.g. an Observation should not have an internal reference to a Patient that doesn't exist. 

[[_TOC_]]

# Introduction to Profiling and Validation

Before diving into how specific design for the FHIR server, here is a small review of Profiling. To assist with the understanding, there is a sample `FHIRValidator` app in [FHIRValidator](FHIRValidator/).

Generally profiling works by constraining an existing profile. In the case of a patient, one could restrict the cardinality or datatype for certain elements. As an example, suppose we wanted to create a profile for a Patient that could not have any Extensions, it could look like this:

```json
{
    "resourceType": "StructureDefinition",
    "id": "PatientWithNoExtensions",
    "url": "http://microsoft.com/fhir/StructureDefinition/PatientWithNoExtensions",
    "name": "PatientWithNoExtensions",
    "status": "draft",
    "date": "2017-04-19T07:44:43+10:00",
    "publisher": "Microsoft Healthcare NExT",
    "description": "Example Patient with no extensions",
    "fhirVersion": "3.0.1",
    "kind": "resource",
    "abstract":false,
    "type":"Patient",
    "baseDefinition":"http://hl7.org/fhir/StructureDefinition/Patient",
    "derivation":"constraint",
    "differential":{
        "element": [
            {
                "id":"Patient.extension",
                "path":"Patient.extension",
                "max": "0"
            }
        ]
    }
}
```

Note that the "snapshot" view of the basic resource has been excluded here, we are just adding a differential view. In this differential view, we are restricting the `extension` field to have max cardinality of zero.

If we consider a simple patient:

```json
{
    "resourceType": "Patient",
    "active": true,
    "name": [
        {
            "use": "official",
            "family": "Kirk",
            "given": [
                "James",
                "Tiberious"
            ]
        },
        {
            "use": "usual",
            "given": [
                "Jim"
            ]
        }
    ],
    "gender": "male",
    "birthDate": "1960-12-25"
}
```

we can use the `FHIRValidator` tool to validate against this profile:

```
dotnet run /FileName .\samples\simple-patient.json /Profile http://microsoft.com/fhir/StructureDefinition/PatientWithNoExtensions

```

we will get:

```
Overall result: SUCCESS
```

If on the other hand we consider a more complcated patient with multiple extensions:

```json
{
  "resourceType": "Patient",
  "id": "9f0817e0-51af-4c3f-8255-c4a9c73407f8",
  "meta": {
    "versionId": "1",
    "lastUpdated": "2019-01-30T03:34:14.9705186+00:00"
  },
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by <a href=\"https://github.com/synthetichealth/synthea\">Synthea</a>.Version identifier: v2.2.0-56-g113d8a2d\n .   Person seed: 3716557023752549642  Population seed: 1546890380968</div>"
  },
  "extension": [
    {
      "extension": [
        {
          "url": "ombCategory",
          "valueCoding": {
            "system": "urn:oid:2.16.840.1.113883.6.238",
            "code": "2106-3",
            "display": "White"
          }
        },
        {
          "url": "text",
          "valueString": "White"
        }
      ],
      "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"
    },
    {
      "extension": [
        {
          "url": "ombCategory",
          "valueCoding": {
            "system": "urn:oid:2.16.840.1.113883.6.238",
            "code": "2186-5",
            "display": "Not Hispanic or Latino"
          }
        },
        {
          "url": "text",
          "valueString": "Not Hispanic or Latino"
        }
      ],
      "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName",
      "valueString": "Kyung736 King743"
    },
    {
      "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
      "valueCode": "M"
    },
    {
      "url": "http://hl7.org/fhir/StructureDefinition/birthPlace",
      "valueAddress": {
        "city": "Springfield",
        "state": "Massachusetts",
        "country": "US"
      }
    }
  ],
  "identifier": [
    {
      "system": "https://github.com/synthetichealth/synthea",
      "value": "97d5ce67-dde6-4ea8-b14f-5673fbe42698"
    },
    {
      "type": {
        "coding": [
          {
            "system": "http://hl7.org/fhir/v2/0203",
            "code": "MR",
            "display": "Medical Record Number"
          }
        ],
        "text": "Medical Record Number"
      },
      "system": "http://hospital.smarthealthit.org",
      "value": "97d5ce67-dde6-4ea8-b14f-5673fbe42698"
    },
    {
      "type": {
        "coding": [
          {
            "system": "http://hl7.org/fhir/identifier-type",
            "code": "SB",
            "display": "Social Security Number"
          }
        ],
        "text": "Social Security Number"
      },
      "system": "http://hl7.org/fhir/sid/us-ssn",
      "value": "999-46-6663"
    },
    {
      "type": {
        "coding": [
          {
            "system": "http://hl7.org/fhir/v2/0203",
            "code": "DL",
            "display": "Driver's License"
          }
        ],
        "text": "Driver's License"
      },
      "system": "urn:oid:2.16.840.1.113883.4.3.25",
      "value": "S99918002"
    },
    {
      "type": {
        "coding": [
          {
            "system": "http://hl7.org/fhir/v2/0203",
            "code": "PPN",
            "display": "Passport Number"
          }
        ],
        "text": "Passport Number"
      },
      "system": "http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber",
      "value": "X58081047X"
    }
  ],
  "name": [
    {
      "use": "official",
      "family": "Gutkowski940",
      "given": [
        "Darwin703"
      ],
      "prefix": [
        "Mr."
      ]
    }
  ],
  "telecom": [
    {
      "system": "phone",
      "value": "555-360-6622",
      "use": "home"
    }
  ],
  "gender": "male",
  "birthDate": "1977-12-02",
  "address": [
    {
      "extension": [
        {
          "extension": [
            {
              "url": "latitude",
              "valueDecimal": 42.601979
            },
            {
              "url": "longitude",
              "valueDecimal": -71.815876
            }
          ],
          "url": "http://hl7.org/fhir/StructureDefinition/geolocation"
        }
      ],
      "line": [
        "954 Klocko Grove Apt 41"
      ],
      "city": "Fitchburg",
      "state": "Massachusetts",
      "postalCode": "01420",
      "country": "US"
    }
  ],
  "maritalStatus": {
    "coding": [
      {
        "system": "http://hl7.org/fhir/v3/MaritalStatus",
        "code": "M",
        "display": "M"
      }
    ],
    "text": "M"
  },
  "multipleBirthBoolean": false,
  "communication": [
    {
      "language": {
        "coding": [
          {
            "system": "urn:ietf:bcp:47",
            "code": "en-US",
            "display": "English"
          }
        ],
        "text": "English"
      }
    }
  ]
}
```

The result would be:

```
Overall result: FAILURE (1 errors and 0 warnings)

[ERROR] Instance count for 'Patient.extension' is 5, which is not within the specified cardinality of 0..0 (at Patient)
```

In this case, we are providing the profile we would like to validate against directly to the validator, but it can also be added to the resource:

```json
{
  "resourceType": "Patient",
  "id": "9f0817e0-51af-4c3f-8255-c4a9c73407f8",
  "meta": {
    "versionId": "1",
    "lastUpdated": "2019-01-30T03:34:14.9705186+00:00",
    "profile": [
        "http://microsoft.com/fhir/StructureDefinition/PatientWithNoExtensions" 
    ]
  },

  // Rest of resource
}
```

As is seen the `profile` metadata field is an array of multiple profiles that this resource conforms to (or should conform to).

# High-Level Design

Describe the high-level design -- enough detail that code reviewers and stakeholders are not surprised.

# Test Strategy

Describe the test strategy.

# Security

Describe any special security implications or security testing needed.

# Other

Describe any impact to localization, globalization, deployment, back-compat, SOPs, ISMS, etc.

