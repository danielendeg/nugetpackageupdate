# IoT Connector K8s platform Blueprint

**STATUS: Work In Progress.**

[[_TOC_]]
# Background
The purpose of this document and PR is to communicate logic view of the high-level design for setting up the IoT Connector K8s platform to manage the Custom Resources and Definitions.

# High Level Integration Architecture
![Integration Architecture](./.images/k8s-arch.jpg)

## RP in Control Plane
In the control plane, the RP request triggered the below workflow on the AKS cluster server.
1. A Custom Resource object will be created on behalf of the Iot Connector. The validation will be run agaist with the Custome Resource Definition(CRD) preset for defining the IoT Connector on the cluster.
2. The IotConnector Resource operator will be invoked to reconcile the request.
3. There will be a new K8s Deployment created for the requeset with metadata and required images.
4. A Pod will be created for the deployment. The Pod will have the containers that run the Docker images. The Docker images will contain Azure functions of the core runtime logic.

After that step, a sub-resource Status will be created under the CRD object to represent whether the deployment has finished. RP can rely on that Status to inform the result in an Async creation process. 

## CI/CD Process
- Build the API model and Operator Controller that are written in GoLang and deploy them to the cluster. The Operator is also running in a Pod.
- Apply the CRD definitions that are written in YAML and deploy them to the cluster.
- Build the core Azure function code into docker images and upload to ACR.
- Build and release library code to Nuget.
- Manage the K8s cluster platform. 
- Manage the runtime environment and core peripheral modules on the AKS, like AAD Pod, key-vault, db, metrics, logging etc.

# Kubernetes Extension API for IoT Connector CRD
The CRD(Custom Resource Definition) defined the resources of the IoT Connector service instance. The API controller will reconcile the incoming request to mutate the states of deployments and their statuses.

## Concepts
### CRD schema
At a high level, the CRD schema includes the information required to create deployments of containers that will run the Azure Function images separately for Normalization, Grouping, and FHIR Transformation. 

There will also be sidecar containers to handle requirements for Managed Identity, Key Vault Management, Metrics, and Security Benchmark. This portion is currently Working-In-Progress. More demo-able code can be found in DICOM's setup.

Schema location: 
- Golang Models: workspace-platform/src/iot-connector/kubernetes/resource-operator/api/v1alpha1/iotconnector_types.go
- YAML: workspace-platform/src/iot-connector/kubernetes/resource-operator/config/crd/bases/services.azurehealthcareapis.com_iotconnectors.yaml    
  Note: **DO NOT** manually update this YAML file. It's auto-generated by the [kubebuilder](https://book.kubebuilder.io/quick-start.html).

### CRD Controller
The CRD Controller reconciles the requests for managing the custom resources. It's currently responsible for creating or updating the deployment of IoT Connector service instance. For now, it's one deployment resource per one IoT connector instance provision. Later, it will also be responsible for coordinating the request with the other resources, for example, Azure Identity. More demo-able code can be found in DICOM's setup.

Controller source:
- workspace-platform/src/iot-connector/kubernetes/resource-operator/controllers/iotconnector_controller.go

# Resource Provision
Resource Provision module includes the libraries for provisioning and de-provisioning the resources for the IoT Connector service instances.

## Package Structure

**Status: The package(namespace) structure should be delineated in the diagram. The model of the CRD API contract details will tend to update.**

![Diagram](./.images/provision-uml-design.jpg)

## Source Structure
```
workspace-platform/src/iot-connector/provision

.
├── Microsoft.Health.Cloud.IoMT.Provision
│   ├── K8s\Api\V1Alpha1\Models   // POCOs for K8s Service model 
│   └── Service
│       ├── Models      // POCOs for modeling Iot Connector Properties and Configuration
│       └── Providers   // Resource Providers
│
└── Microsoft.Health.Cloud.IoMT.Provision.Console //  Console App example 
```
