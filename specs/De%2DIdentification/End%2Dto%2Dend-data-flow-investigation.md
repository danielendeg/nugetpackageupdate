# End-to-end data flow investigation
[[_TOC_]]

This document mainly discusses inserting anonymized data generated by FHIR-Tool-for-Anonymization into FHIR Server.

## Data anonymization
Currently, FHIR-Tool-for-Anonymization supports 3 anonymization methods: _redact_, _dateShift_ and _keep_.
- For _kept_, _shifted_ and _partially redacted_ fields, values are neither empty nor null.
They are of the same as other regular FHIR data.
- For _completely redacted_ fields, values are empty or null.
They are discussed in following sections.

## FHIR Server resource validation
When creating data in FHIR Server, there is a validation preprocess that checks whether the input resource meets some requirements.
If not, exceptions will be thrown and creation will be rejected.

1. **The resource _id_ follows a certain format.**
Anonymizing will not bring in extra violation to this rule, as _id_ is not modified by default anonymization configuration.

2. **The xhtml in _Narrative.div_ is valid if it's not null or empty.**
Anonymizing will not bring in extra violation to this rule, as anonymized _Narrative.div_ is null.

3. **The required fields of the resource are correctly provided.**
Anonymizing may violate this rule.
For example, _Endpoint.address_ is a required field of _Endpoint_, but may contain personal email addresses.
After anonymization, if required fields are completely redacted to empty or null, the input resources will be rejected with  _ResourceNotValidException_.
Note that required fields are **not** checked recursively, which means only children of root resources are checked.

## Conflict between anonymization and validation
Anonymization aims to ensure that identifiers defined by HIPAA Safe Harbor method are correctly anonymized.

Validation aims to ensure that resources are correctly provided according to FHIR resource definitions.

These two requirements may not be satisfied at the same time.
The conflict is that **required fields can contain identifiers**.
If these fields are kept, it does not meet the requirement of HIPAA Safe Harbor method.
If these fields are anonymized, it does not meet the requirement of FHIR resource definitions.

There are several solutions to solve this issue:
- **Solve from validation side.**
Open another validation preprocess for anonymized data.
The validation of other data keep unchanged. 
- **Solve from anonymization side.**
Instead of redacting the fields to completely empty or null, figure out some way to keep some valid values in required fields.

Solutions will be discussed in following sections.

## Required fields
Required fields refer to those marked _min cardinality > 0_ in FHIR resource definitions.
These fields may contain identifiers defined by HIPAA Safe Harbor method.
Among all FHIR resources, there are 26 required fields that may be anonymized by default configuration.

|Data type|Count|Fields|
|:-:|:-:|:-:|
|Attachment|1|Media.content|
|string (url/markdown)|2|Endpoint.address, SearchParameter.description|
|date/dateTime/instant|15|CapabilityStatement.date, MessageDefinition.date, NamingSystem.date, TerminologyCapabilities.date, Provenance.recorded, AuditEvent.recorded, Composition.date, Slot.start, Slot.end, CoverageEligibilityRequest.created, CoverageEligibilityResponse.created, Claim.created, ClaimResponse.created, PaymentNotice.created, PaymentReconciliation.created, PaymentReconciliation.paymentDate, ExplanationOfBenefit.created, MedicationAdministration.effective, ImmunizationRecommendation.date, NutritionOrder.dateTime, VisionPrescription.created, VisionPrescription.dateWritten|
|polymorphism|1|Immunization.occurence (dateTime/string)|

Following are several validation result examples:

|Media.content (Attachement)|Result|
|:-:|:-:|
|**"content": \{"data": ""\}**|**OK**|
|"content": \{\}|Invalid|
|"content": "" (March release)|Invalid|
|null (PR#16)|Invalid|

|Endpoint.address (string)|Result|
|:-:|:-:|
|"address": "mailto:MARTIN.SMIETANKA@directnppes.com"|OK|
|**"address": "\*\*\*\*\*\*" (characterMask)**|**OK**|
|"address": 1.01|OK|
|"address": true|OK|
|"address": "" (March release)|Invalid|
|null (PR#16)|Invalid|

|Slot.start (date\dateTime\instant)|Result|
|:-:|:-:|
|"start": "1913-12-25T09:15:00Z"|OK|
|**"start": "0001-01-01T00:00:00Z" (default dateTime)**|**OK**|
|"start": "0000-00-00T00:00:00Z"|Invalid|
|"start": "******"|Invalid|
|"start": "" (March release)|Invalid|
|null (PR#16)|Invalid|


## Possible solutions
1. **Open another validation preprocess for anonymized data.**
Based on our current understanding, Google does not validate the input resources.
In [Googleâ€™s document](https://cloud.google.com/healthcare/docs/how-tos/fhir-resources), a resource with required field missing (_Observation.code_) is successfully created.
We can open another validation preprocess in FHIR Server, which loosens the constraint of fields that may contain identifiers.
This solution needs further discussion with FHIR Server team.


1. **Figure out some way to make fields not completely empty or null.**
- **For date/dateTime/instant data**, we can change the value of complete redaction from empty or null to _0001-01-01_ (the default value of dateTime in C#).
Besides, we recommend users to set partial redaction _enabled_ to minimize the number of complete redactions.
- **For string data**, we can support and recommend users to use _characterMask_.
With _characterMask_, values will be strings made up of masking characters instead of empty or null.
- **For Attachement data**,
  - We can anonymize "_Attachment.data/url_" instead of the whole Attachment.
Besides, we need to keep empty fields in output resources, shown in first Media.content example.
So there will always be some value in this field.
  - There is only one Attachment in required fields.
We can tell users about this special case and let users choose whether to anonymize it or not.

