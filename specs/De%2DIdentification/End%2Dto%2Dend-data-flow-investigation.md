[[_TOC_]]

This document mainly discusses inserting anonymized FHIR resources generated by FHIR-Tool-for-Anonymization into FHIR Server.

# FHIR resource anonymization
Currently, FHIR-Tool-for-Anonymization supports 3 anonymization methods: _redact_, _dateShift_ and _keep_.
- For _kept_, _shifted_ and _partially redacted_ fields, values are neither empty nor null.
They are of the same as other regular FHIR resources.
- For _completely redacted_ fields, values are empty or null.
They are discussed in following sections.

# FHIR Server resource validation
Based on our current understanding, when creating resources in FHIR Server, there is a validation preprocess that checks whether the input resource meets some requirements.
If not, exceptions will be thrown and creation will be rejected.

**1. The resource _id_ follows a certain format.**
Anonymizing will not bring in extra violation to this rule, as _id_ is not modified by default anonymization configuration.

**2. The xhtml in _Narrative.div_ is valid if it's not null or empty.**
Anonymizing will not bring in extra violation to this rule, as anonymized _Narrative.div_ is null.

**3. The required fields of the resource are correctly provided.**
Anonymizing may violate this rule.
For example, _Endpoint.address_ is a required field of _Endpoint_, but may contain personal email addresses.
After anonymization, if required fields are completely redacted to empty or null, the input resources will be rejected with  _ResourceNotValidException_.
Currently, required fields are **not** checked recursively, which means only children of root resources are checked.

# Conflict between anonymization and validation
Anonymization aims to ensure that identifiers defined by HIPAA Safe Harbor method are correctly anonymized.

Validation aims to ensure that resources are correctly provided according to FHIR resource definitions.

These two requirements may not be satisfied at the same time.
The conflict is that **required fields can contain identifiers**.
If these fields are kept, it does not meet the requirement of HIPAA Safe Harbor method.
If these fields are anonymized, it does not meet the requirement of FHIR resource definitions.

There are several solutions to solve this issue:
- **Solve from validation.**
Add security label to _Resource.meta.security_ in anonymized resources.
Set another validation preprocess for anonymized resources.
- **Solve from anonymization.**
Instead of redacting the fields to completely empty or null, figure out some way to keep some valid values in required fields.

Solutions will be discussed in following sections.

# Required fields
Required fields refer to those marked _min cardinality > 0_ in FHIR resource definitions.
These fields may contain identifiers defined by HIPAA Safe Harbor method.
Among all FHIR resources, there are 26 required fields that may be anonymized by default configuration.

|Data|Type|Count|Fields|
|:-:|:-:|:-:|:-:|
|Attachment|complex|1|Media.content|
|string (url/markdown)|primitive|2|Endpoint.address, SearchParameter.description|
|date/dateTime/instant|primitive|22|CapabilityStatement.date, MessageDefinition.date, NamingSystem.date, TerminologyCapabilities.date, Provenance.recorded, AuditEvent.recorded, Composition.date, Slot.start, Slot.end, CoverageEligibilityRequest.created, CoverageEligibilityResponse.created, Claim.created, ClaimResponse.created, PaymentNotice.created, PaymentReconciliation.created, PaymentReconciliation.paymentDate, ExplanationOfBenefit.created, MedicationAdministration.effective, ImmunizationRecommendation.date, NutritionOrder.dateTime, VisionPrescription.created, VisionPrescription.dateWritten|
|choice of types|both|1|Immunization.occurence (dateTime/string)|

Following are several validation result examples:

|Media.content (Attachement)|Result|
|:-:|:-:|
|**"content": \{"contentType": "image/gif", "data": ""\}**|**OK**|
|**"content": \{"url": "\*\*\*\*\*\*"\}**|**OK**|
|"content": \{"data": ""\}|OK|
|"content": \{\}|Invalid|
|"content": "" (March release)|Invalid|
|null (PR#16)|Invalid|

|Endpoint.address (string)|Result|
|:-:|:-:|
|"address": "mailto:MARTIN.SMIETANKA@directnppes.com"|OK|
|**"address": "\*\*\*\*\*\*"**|**OK**|
|"address": 1.01|OK|
|"address": true|OK|
|"address": "" (March release)|Invalid|
|null (PR#16)|Invalid|

|Slot.start (date\dateTime\instant)|Result|
|:-:|:-:|
|"start": "1913-12-25T09:15:00Z"|OK|
|**"start": "0001-01-01T00:00:00Z" (default dateTime)**|**OK**|
|"start": "0000-00-00T00:00:00Z"|Invalid|
|"start": "******"|Invalid|
|"start": "" (March release)|Invalid|
|null (PR#16)|Invalid|

# Possible solutions
**1. Set another validation preprocess for anonymized resources.**
We can **set another validation preprocess** for anonymized resources in FHIR Server, which loosens the constraint of fields that may contain identifiers.
We also need to **add a security label for the anonymized resources** in FHIR-Tool-for-Anonymization to distinguish them from other regular resources.
This solution needs further discussion with FHIR Server team.

(Based on our current understanding, Google does not validate the input resources.
In [Googleâ€™s document](https://cloud.google.com/healthcare/docs/how-tos/fhir-resources), a resource with required field missing (_Observation.code_) is successfully created.)

**2. Figure out some way to make fields not completely empty or null.** This solution requires no change in FHIR Server.
- **For date/dateTime/instant data**, we can change the value of complete redaction from empty or null to _0001-01-01_ (the default value of dateTime in C#). We may need to **double check** whether this behavior follows [HIPAA Safe Harbor method](https://www.hhs.gov/hipaa/for-professionals/privacy/special-topics/de-identification/index.html#safeharborguidance).
Besides, we recommend users to set partial redaction _enabled_ to minimize the number of complete redactions.
- **For string data**, we can support and recommend users to use _characterMask_.
With _characterMask_, values will be strings made up of masking characters instead of empty or null.
- **For [Attachment](https://www.hl7.org/fhir/datatypes.html#Attachment) data**, different from above two primitive types, Attachment is a complex type that made up of several children fields.
They are implemented in 2 ways: a) setting _Attachment.data_ with _Attachment.contentType_; b) setting _Attachment.url_.
In both ways, we need to make sure not all fields are empty or null.
We can support and set up 3 _extended typeRules_ instead of anonymizing the whole Attachment in original configuration: "_Attachment.data: redact_", "_Attachment.contentType: keep_" "_Attachment.url: characterMask_".
So there will always be some value in Attachment's children fields.

