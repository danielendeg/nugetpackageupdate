[[_TOC_]]

This document mainly discusses inserting anonymized FHIR resources generated by FHIR-Tool-for-Anonymization into FHIR Server.

# Problem context
## FHIR resource anonymization
Currently, FHIR-Tool-for-Anonymization supports 3 anonymization methods: _redact_, _dateShift_ and _keep_.

- _redact_: can be further divided into _complete redact_ and _partial redact_. _complete redact_ removes the fields directly. _partial redact_ tries to keep as much information as possible, like initial digits of zip codes, ages not over 89, etc.
- _dateShift_: shifting the value within a 100-day differential.
- _keep_: retain the value as it is.

For _completely redacted_ fields, values are empty or null.
These data may cause the incompatibility between FHIR-Tool-for-Anonymization and FHIR Server.

## FHIR Server resource validation
Based on our current understanding, when creating resources in FHIR Server, there is a validation preprocess that checks whether the input resource meets some requirements.
If not, exceptions will be thrown and creation will be rejected.

**1. The resource _id_ follows a certain format.**
Anonymizing will not bring in extra violation to this rule, as _id_ is not modified by default anonymization configuration.

**2. The xhtml in _Narrative.div_ is valid if it's not null or empty.**
Anonymizing will not bring in extra violation to this rule, as anonymized _Narrative.div_ is null.

**3. The resource is correctly provided, including required fields.**
Anonymizing may violate this rule.
For example, _Endpoint.address_ is a required field, but it may contain personal email addresses.
After anonymization, _Endpoint.address_ is completely redacted to empty or null.
It is rejected with _ResourceNotValidException_ by FHIR Server.

## Required fields
Required fields refer to those marked _min cardinality > 0_ in FHIR resource definitions.
But these fields may contain identifiers defined by HIPAA Safe Harbor method.
Among all FHIR resources, we have find out 26 required fields that may be completely redacted to empty or null by default configuration.

|Data|Type|Count|Fields|
|:-:|:-:|:-:|:-:|
|Attachment|complex|1|Media.content|
|string (url/markdown)|primitive|2|Endpoint.address, SearchParameter.description|
|date/dateTime/instant|primitive|22|CapabilityStatement.date, MessageDefinition.date, NamingSystem.date, TerminologyCapabilities.date, Provenance.recorded, AuditEvent.recorded, Composition.date, Slot.start, Slot.end, CoverageEligibilityRequest.created, CoverageEligibilityResponse.created, Claim.created, ClaimResponse.created, PaymentNotice.created, PaymentReconciliation.created, PaymentReconciliation.paymentDate, ExplanationOfBenefit.created, MedicationAdministration.effective, ImmunizationRecommendation.date, NutritionOrder.dateTime, VisionPrescription.created, VisionPrescription.dateWritten|
|choice of types|both|1|Immunization.occurence (dateTime/string)|

Following are several validation result examples:

|Media.content (Attachment)|Result|
|:-:|:-:|
|**"content": \{"contentType": "image/gif", "data": ""\}**|**OK**|
|**"content": \{"url": "\*\*\*\*\*\*"\}**|**OK**|
|"content": \{"data": ""\}|OK|
|"content": \{\}|Invalid|
|"content": ""|Invalid|
|null (now)|Invalid|

|Endpoint.address (string)|Result|
|:-:|:-:|
|"address": "mailto:MARTIN.SMIETANKA@directnppes.com"|OK|
|**"address": "\*\*\*\*\*\*"**|**OK**|
|"address": 1.01|OK|
|"address": true|OK|
|"address": ""|Invalid|
|null (now)|Invalid|

|Slot.start (date\dateTime\instant)|Result|
|:-:|:-:|
|"start": "1913-12-25T09:15:00Z"|OK|
|**"start": "0001-01-01T00:00:00Z" (default dateTime)**|**OK**|
|"start": "0000-00-00T00:00:00Z"|Invalid|
|"start": "******"|Invalid|
|"start": ""|Invalid|
|null (now)|Invalid|

Currently, required fields are not checked recursively in FHIR Server, which means only the children of root resource are checked.

## Conflict between anonymization and validation
Anonymization aims to ensure that identifiers defined by HIPAA Safe Harbor method are correctly anonymized.

Validation aims to ensure that resources are correctly provided according to FHIR resource definitions.

These two requirements may not be satisfied at the same time.
The conflict is that **required fields can contain identifiers**.
If these fields are kept, it does not meet the requirement of HIPAA Safe Harbor method.
If these fields are anonymized, it does not meet the requirement of FHIR resource definitions.

# Possible solutions
## 1. Set another validation preprocess for anonymized resources in FHIR Server.
We can **set another validation preprocess** for anonymized resources in FHIR Server, which loosens the constraint of fields that may contain identifiers.
We also need to **add a security label for the anonymized resources** in FHIR-Tool-for-Anonymization to distinguish them from other regular resources.
This solution needs further discussion with FHIR Server team.

Example of security labels in anonymized resources:
```json
{
  "resourceType": "Endpoint",
  "id": "direct-endpoint",
  "meta" : {
    "security": [{
      "system": "https://www.hl7.org/fhir/v3/ObservationValue/cs.html#v3-ObservationValue",
      "code": "REDACTED",
      "display": "Fields contain identifiers defined by HIPAA Safe Harbor method are redacted."
  }]},
  ...
}
```

The security labels can be accessed from FHIR Server with:
```
List<Coding> securityLabels = resource?.Meta?.Security;
```

- More information about security labels could be found in [spec](https://www.hl7.org/fhir/security-labels.html) and user story #72972.

## 2. Figure out some way to make fields not completely empty or null in FHIR-Tool-for-Anonymization.
This solution requires no change in FHIR Server.
- **For date/dateTime/instant data**, we can change the value of complete redaction from empty or null to _0001-01-01_ (the default value of dateTime in C#). We may need to **double check** whether this behavior follows [HIPAA Safe Harbor method](https://www.hhs.gov/hipaa/for-professionals/privacy/special-topics/de-identification/index.html#safeharborguidance).
Besides, we recommend users to set partial redaction _enabled_ to minimize the number of complete redactions.
- **For string data**, we can support and recommend users to use _characterMask_.
With _characterMask_, values will be strings made up of masking characters instead of empty or null.
- **For [Attachment](https://www.hl7.org/fhir/datatypes.html#Attachment) data**, different from above two primitive types, Attachment is a complex type that made up of several children fields.
They are implemented in 2 ways: a) setting _Attachment.data_ with _Attachment.contentType_; b) setting _Attachment.url_.
In both ways, we need to make sure not all fields are empty or null.
We can support and set up 3 _extended typeRules_ instead of anonymizing the whole Attachment in original configuration: "_Attachment.data: redact_", "_Attachment.contentType: keep_" "_Attachment.url: characterMask_".
So there will always be some value in Attachment's children fields.

## 3. Add a command-line option _validate_ to validate anonymized resources.
This solution does not solve the incompatibility, but it tells users what makes them incompatible.

|Option|Name|Optionality|Default|Description|
|:-:|:-:|:-:|:-:|:-:|
|validate|validate|Optional|false|Validate anonymized resource files in verbose log|

With this parameter set to true, users will get a detailed report in verbose log if the resource is non-conformant.

When the anonymization of a certain resource is done, we first check whether the **anonymized resource** is valid. If valid, we continue processing the next resource. If invalid, we further check whether the **input resource** is valid. Then we classify the errors of anonymized resources into 2 categories: errors caused by invalid input and errors caused by anonymization.

Example input resource:
```json
{
  "resourceType": "Slot",
  "id": "3",
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">\n\t\t\t25 Dec 2013 9:30am - 9:45am: <b>Unavailable</b> Physiotherapy<br/>\n\t\t\tDr Careful is out of the office\n\t\t</div>"
  },
  "serviceCategory": [
    {
      "coding": [
        {
          "code": "17",
          "display": "General Practice"
        }
      ]
    }
  ],
  "schedule": {
    "reference": "Schedule/example"
  },
  "status": "busy-unavailable",
  "end": "1913-12-25T09:45:00Z",
  "comment": "Dr Careful is out of the office"
}
```

After anonymization:
```json
{
  "resourceType": "Slot",
  "id": "3",
  "serviceCategory": [
    {
      "coding": [
        {
          "code": "17",
          "display": "General Practice"
        }
      ]
    }
  ],
  "schedule": {
    "reference": "Schedule/example"
  },
  "status": "busy-unavailable"
}
```
Validation result in verbose log:
```
dbug: Fhir.Anonymizer.Core.Validation.ResourceValidator[0]
      The output is non-conformant with FHIR spec due to non-conformant input: Element with min. cardinality 1 cannot be null for Slot.StartElement.
dbug: Fhir.Anonymizer.Core.Validation.ResourceValidator[0]
      The output is non-conformant with FHIR spec due to anonymization: Element with min. cardinality 1 cannot be null for Slot.EndElement.
```

In above example, the anonymized resource is invalid due to 2 reasons. _Slot.start_ is not provided in the input. _Slot.end_ is redacted after anonymization, as it's indicative of age over 89.