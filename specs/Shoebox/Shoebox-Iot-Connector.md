*This spec outlines how we will expose Iot Connector logs and metrics to customers as part of the Jupiter release*

[[_TOC_]]

# Business Justification

Customers will need access to metrics to understand usage, and troubleshoot errors. This design outlines what IoT Connector metrics are in scope for the Jupiter release.

# Scenarios
- Customer can view IoT Connector metrics in Azure Monitor.

# Out of Scope
- We are not enabling IoT Connector diagnotic logs in Azure Monitor at this time. As of the writing of this document, we do not have any logs to emit for customers. We only have metrics at this time.
- We are not enabling IoT Connector audit logs in Azure Monitor at this time. Currently we do not have users viewing IoT data in Azure. The data is persisted in FHIR and an end user would interact with the persisted FHIR data rather than the messages flowing through the IoT connector.  However there have been some requests by customers to have some way of knowing what user the data is tied to. For example if an admin user is handing out devices to patients for data collection, it might be helpful to have that user data in FHIR somewhere, or in an audit log somewhere. This may be a good use for the [Provenence FHIR resource type](https://www.hl7.org/fhir/provenance.html) which is a record that describes entities and processes involved in producing and delivering or otherwise influencing that resource.

# Metrics
No additional metrics beyond the ones listed below in the design.

# Design
*Describe the design with enough detail that code reviewers and stakeholders are not surprised.*

**We will be continuing to use the IoT Connector Metrics from Gen 1 (below)**

| Metric                                     | Exportable via Diagnostic Settings? | Metric Display Name             | Unit         | Aggregation Type | Description                                                                                                                                           | Dimensions                                                                                     |
|--------------------------------------------|-------------------------------------|---------------------------------|--------------|------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------|
| IoTConnectorDeviceEvent                    | Yes                                 | Number of Incoming Messages     | Count        | Sum              | The total number of messages received by the Azure IoT Connector for FHIR prior to any normalization.                                                 | Operation, ConnectorName                                                                       |
| IoTConnectorDeviceEventProcessingLatencyMs | Yes                                 | Average Normalize Stage Latency | Milliseconds | Average          | The average time between an event's ingestion time and the time the event is processed for normalization.                                             | Operation, ConnectorName                                                                       |
| IoTConnectorMeasurement                    | Yes                                 | Number of Measurements          | Count        | Sum              | The number of normalized value readings received by the FHIR conversion stage of the Azure IoT Connector for FHIR.                                    | Operation, ConnectorName                                                                       |
| IoTConnectorMeasurementGroup               | Yes                                 | Number of Message Groups        | Count        | Sum              | The total number of unique groupings of measurements across type, device, patient, and configured time period generated by the FHIR conversion stage. | Operation, ConnectorName                                                                       |
| IoTConnectorMeasurementIngestionLatencyMs  | Yes                                 | Average Group Stage Latency     | Milliseconds | Average          | The time period between when the IoT Connector received the device data and when the data is processed by the FHIR conversion stage.                  | Operation, ConnectorName                                                                       |
| IoTConnectorNormalizedEvent                | Yes                                 | Number of Normalized Messages   | Count        | Sum              | The total number of mapped normalized values outputted from the normalization stage of the the Azure IoT Connector for FHIR.                          | Operation, ConnectorName                                                                       |
| IoTConnectorTotalErrors                    | Yes                                 | Total Error Count               | Count        | Sum              | The total number of errors logged by the Azure IoT Connector for FHIR                                                                                 | Name, Operation, ErrorType, ErrorSeverity, ConnectorName                                       |

**We will be adding the following metrics as part of the Jupiter release (P0)**

| Metric                                     | Additions / Notes
|--------------------------------------------|--------------------------------------|
| IoTConnectorTotalErrors                    | Add implementation for EventHubError
| IoTConnectorTotalErrors                    | Add implementation for FHIRServerError (add dimension for the specific error 429, 500, etc)
| IoTConnectorTotalErrors                    | Add implementation for DeviceTemplateError
| IoTConnectorTotalErrors                    | Add implementation for FHIRTemplateError
| IoTConnectorFhirResourceSaved              | Add new metric to show that a FHIR resource has been created or updated (have a dimension for created vs. updated)
| IoTConnectorDeviceIngressSizeBytes         | Add new metric to show amount of incoming bytes processed by the IoT Connector in the normalization stage (used for billing)

**These are new metrics we would like to add, time permitting (P1)**

| Metric                                     | Exportable via Diagnostic Settings? | Metric Display Name                            | Unit         | Aggregation Type | Description                                                                                                           | Dimensions                      |
|--------------------------------------------|-------------------------------------|------------------------------------------------|--------------|------------------|-----------------------------------------------------------------------------------------------------------------------|---------------------------------|
| IoTConnectorTemplateMatch                  | Yes                                 | Number of messages with a matching template    | Count        | Sum              | The total number of messages received by the Azure IoT Connector for FHIR with a matching mapping template section.   | Operation, ConnectorName (TBD)  |
| IoTConnectorTemplateMatchNotFound          | Yes                                 | Number of messages without a matching template | Count        | Sum              | The average time between an event's ingestion time and the time the event is processed for normalization.             | Operation, ConnectorName (TBD)  |

**Jupiter UI work (P0)**
We will essentially need to port over the Gen1 metrics UI to the Jupiter UI. The changed needed for this are TBD but there should not be too much additional work.

**Jupiter UI work (P1)**
We discussed having the portal display the "health state" of the connector. This would be useful. The implementation for this is TBD. As an interim step we can emit the necessary metrics that we could potentially build the UI on (fhir server errors, event hub errors, etc). Then we can write the UI. We could also create some sort of REST API without having to rely on metrics if we want to go that route instead.

Notes:
We had previously considered using logs for all the different connectivity errors (fhir server, event hub, etc). However there were concerns about cluttering the log. We discussed having a customer facing "health status" of the connector mentioned above as an alternative. 
Pros with metrics:
1. Customers can see what is potentially wrong with their connector in one place.
2. Potentially less "exception" logs for DRI to look at.
3. Metrics still would populate MetricTelemetry table so CSS would have access to query metrics.

Cons:
1. There is not currently a good way to export metrics with all dimensions. You can only export the metric and it's value, but none of the dimension names/values. The only way to get metric dimension names/values is to export via REST API, which puts extra burden on the customer.

Open questions: 
1. Should metrics be logged at workspace level, or connector level? (Either way may want to include both workspace id and connector id as properties)
2. What properties differentiate IoT metrics from FHIR or DICOM metrics? Name prefix only? Anything else?

# Other
During the technical implmentation of this design, it would be nice to unify logging and metrics implementations across Dicom, IoT, and FHIR. This is explored further in the spec below.

Links:
- [Inventory of Loggers](https://microsofthealth.visualstudio.com/Health/_git/health-paas-docs?path=%2Fspecs%2FPaaS%2Ftelemetry%2FLoggerInventory.md&version=GBmaster&_a=preview)
